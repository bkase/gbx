<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>GBX2 WASM Transport Tests</title>
  </head>
  <body>
    <script type="module">
      // Single WASM module contains both test functions and worker functions
      import init, {
        wasm_smoke_test,
        wasm_transport_worker_flood_frames,
        wasm_transport_worker_burst_fairness,
        wasm_transport_worker_backpressure_recovery,
        wasm_inspector_debug_smoke,
      } from './pkg/fabric_worker_wasm.js';

      async function run() {
        try {
          // Initialize the single WASM module in the main thread
          // This pattern matches gbx-playground: main thread inits first,
          // then workers use the same module with shared memory
          console.log('Main thread: Initializing fabric_worker_wasm module...');
          await init(new URL('./pkg/fabric_worker_wasm_bg.wasm', import.meta.url));
          const steps = [
            ['wasm_smoke_test', wasm_smoke_test],
            ['wasm_transport_worker_flood_frames', wasm_transport_worker_flood_frames],
            ['wasm_transport_worker_burst_fairness', wasm_transport_worker_burst_fairness],
            ['wasm_transport_worker_backpressure_recovery', wasm_transport_worker_backpressure_recovery],
            ['wasm_inspector_debug_smoke', wasm_inspector_debug_smoke],
          ];

          for (const [name, fn] of steps) {
            try {
              console.log(`WASM_TEST_START:${name}`);
              await fn();
              console.log(`WASM_TEST_PASS:${name}`);
            } catch (err) {
              console.error(`WASM_TEST_FAIL:${name}`, err);
              console.error(`WASM_TEST_FAIL:${name}:message`, err.message || String(err));
              throw err;
            }
          }

          console.log('WASM_TEST_DONE');
        } catch (err) {
          console.error('WASM_TEST_FAIL', err);
        }
      }

      run();
    </script>
  </body>
</html>
